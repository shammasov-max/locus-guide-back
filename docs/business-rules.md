# Бизнес-правила Locus Guide

Документ описывает бизнес-правила для backend-системы мультиязычного мобильного аудиогида.

Источник: обсуждение версионирования маршрутов между Stanislav Svarichevsky (менеджер) и Max Shammasov (разработчик), декабрь 2025.

---

## 1. Route Version Lifecycle (Жизненный цикл версий маршрутов)

### BR-001: Создание версии при публикации
**Правило**: Версия маршрута создается ТОЛЬКО при первой публикации маршрута.

**Детали**:
- До публикации у маршрута НЕТ версий (таблица `route_versions` пуста)
- При первом нажатии "Publish" создается `route_version` с `version_no = 1`, `status = 'published'`
- `routes.published_version_id` устанавливается на новую версию

**Пример**:
```
Маршрут создан (draft) → routes.published_version_id = NULL
Нажали "Publish" → route_version (v1, status='published') создана
routes.published_version_id = v1
```

**Связанные US**: US-021, US-038

---

### BR-002: Отсутствие версий до публикации
**Правило**: До публикации у draft-маршрута нет версий, только JSON внутри таблицы `routes`.

**Детали**:
- Редактор работает с draft-маршрутом через `routes.geojson` (если есть такое поле)
- Таблица `route_versions` остается пустой для этого маршрута
- Checkpoint'ы не создаются до публикации

**Связанные US**: US-019, US-020

---

### BR-003: Создание версии при структурных изменениях
**Правило**: Новая версия создается ТОЛЬКО при добавлении или удалении checkpoint'ов в опубликованном маршруте.

**Детали**:
- "Структурное изменение" = добавление/удаление точек
- При попытке add/delete checkpoint в published версии:
  - Система создает новую draft версию (version_no = N+1)
  - Копирует все checkpoint'ы из текущей published версии
  - Применяет изменение к новой draft версии
- Текущая published версия остается неизменной (для пользователей, уже начавших маршрут)

**Пример**:
```
Маршрут v1 (published, 10 точек) → пользователи проходят
Редактор добавляет 11-ую точку → создается v2 (draft, 11 точек)
Пользователи на v1 продолжают проходить 10 точек
После публикации v2 → новые пользователи получат 11 точек
```

**Связанные US**: US-038

---

### BR-004: Изменение метаданных не создает версию
**Правило**: Изменение метаданных точек (title, description, audio URLs) в опубликованной версии НЕ создает новую версию (in-place update).

**Детали**:
- Метаданные, которые можно менять "задним числом":
  - `title_i18n` (исправление опечаток)
  - `description_i18n` (уточнение описаний)
  - `audio_urls` (замена аудио файлов)
- Изменения применяются к существующей published версии
- ВСЕ пользователи (включая тех, кто уже начал маршрут) видят обновленные данные

**Обоснование**: Нет смысла создавать копию из-за опечатки в одной букве.

**Связанные US**: US-037

---

### BR-005: Иммутабельность структуры published версии
**Правило**: Опубликованная версия иммутабельна по структуре - нельзя менять порядок точек и их ID.

**Детали**:
- Запрещено для published версии:
  - Изменение `checkpoint.id`
  - Изменение `seq_no` (порядок прохождения)
  - Перестановка точек местами
- Разрешено:
  - Изменение `display_number` (видимый номер для пользователя) - НЕТ, тоже нельзя
  - Изменение метаданных (title, description, audio)

**Обоснование**: Изменение ID или порядка сломает прогресс пользователей (`visited_points` таблица).

**Связанные US**: US-036, US-037

---

### BR-006: Редактор работает с актуальной версией
**Правило**: Редактор всегда работает с последней draft-версией маршрута.

**Детали**:
- В админке редактор видит только актуальную версию для редактирования
- Предыдущие published версии доступны только для просмотра (read-only)
- Правки предыдущих версий не имеют смысла - правим актуальную

**Связанные US**: US-019, US-020, US-037

---

## 2. User Progress & Version Locking (Прогресс пользователя и блокировка версий)

### BR-007: Version locking при старте маршрута
**Правило**: Пользователь, начавший маршрут, "заблокирован" на версию маршрута через `user_active_routes.locked_version_id`.

**Детали**:
- При вызове `POST /api/v1/routes/{id}/start`:
  - Создается запись в `user_active_routes`
  - `locked_version_id` = `routes.published_version_id` (текущая published версия)
  - UNIQUE constraint на (user_id, route_id) гарантирует одну активную сессию
- Пользователь "привязан" к этой версии до завершения маршрута

**Связанные US**: US-021, US-036

---

### BR-008: Изоляция пользователей от новых версий
**Правило**: Если редактор опубликовал новую версию, пользователи на старой версии не видят новые точки до завершения маршрута.

**Детали**:
- Пользователь начал маршрут v2 (10 точек)
- Редактор опубликовал v3 (12 точек)
- Пользователь продолжает видеть только 10 точек из v2
- При вызове `GET /api/v1/routes/{id}/checkpoints`:
  - Backend возвращает checkpoints из `user_active_routes.locked_version_id`
  - А не из `routes.published_version_id`

**Обоснование**: Предотвращает рассинхронизацию прогресса (количество точек изменилось).

**Связанные US**: US-021, US-036

---

### BR-009: Запрет на выбор версий пользователем
**Правило**: Пользователь НЕ может выбирать версии маршрута вручную - только та версия, на которой он начал.

**Детали**:
- В мобильном приложении нет UI для выбора версии
- Версия определяется автоматически при `POST /start`
- Единственный способ получить новую версию - завершить маршрут и начать заново

**Связанные US**: US-021, US-036

---

### BR-010: Persistence version lock при длительных перерывах
**Правило**: Пользователь может продолжить маршрут после длительного перерыва (даже через неделю) на той же версии (version lock persist).

**Детали**:
- `user_active_routes.completed_at = NULL` → маршрут активен
- Пользователь закрыл приложение → version lock сохраняется
- Пользователь удалил приложение и переустановил → version lock сохраняется (синхронизация с сервером)
- Пользователь зашел с другого устройства → version lock сохраняется (тот же user_id)

**Связанные US**: US-036

---

## 3. Content Editing Rules (Правила редактирования контента)

### BR-011: In-place обновление метаданных
**Правило**: В опубликованной версии можно менять `title_i18n`, `description_i18n`, audio URLs "задним числом".

**Детали**:
- Изменения применяются к существующей published версии
- Новая версия НЕ создается
- Все пользователи видят обновления при следующей синхронизации

**Use cases**:
- Исправление опечаток в названиях точек
- Уточнение описаний
- Замена качества audio файлов

**Связанные US**: US-037

---

### BR-012: Запрет на изменение checkpoint.id
**Правило**: Нельзя менять `checkpoint.id` в опубликованной версии - это сломает прогресс.

**Детали**:
- `visited_points` таблица ссылается на `checkpoint.id`
- Изменение ID приведет к потере связи с прогрессом
- Единственный способ изменить ID - создать новую версию (BR-003)

**Связанные US**: US-036, US-037

---

### BR-013: Минимальные изменения не требуют версионирования
**Правило**: Изменение одной буквы в названии не должно требовать создания новой версии.

**Обоснование**: Этого будет много - редакторы часто исправляют опечатки.

**Связанные US**: US-037

---

### BR-014: Предупреждение при структурных изменениях
**Правило**: При структурных изменениях (add/delete checkpoint) в опубликованной версии должно быть админское предупреждение.

**Детали**:
- При попытке добавить/удалить точку в published версии:
  - Backend возвращает HTTP 409 Conflict (без `?confirm_structure_change=true`)
  - Сообщение: "Будет создана новая draft-версия. N пользователей останутся на старой версии."
- Frontend показывает modal с подтверждением
- После подтверждения: создается новая draft версия (BR-003)

**Связанные US**: US-038

---

## 4. Multilingual Content (Мультиязычный контент)

### BR-015: Постепенное добавление языков
**Правило**: Языки можно добавлять постепенно к опубликованному маршруту.

**Детали**:
- Маршрут опубликован с `available_languages = ['en', 'ru']`
- Контент-менеджер начинает добавлять испанский:
  - Загружает audio файлы для некоторых точек
  - Переводит описания для некоторых точек
- Испанский язык НЕ виден пользователям до полной готовности

**Связанные US**: US-039

---

### BR-016: Видимость языка при полной готовности
**Правило**: Язык не показывается пользователям до полного заполнения всех audio/текстов для этого языка.

**Детали**:
- В `route_version` два поля:
  - `languages: text[]` - все языки, включая "in progress"
  - `available_languages: text[]` - языки, видимые пользователям
- Контент-менеджер отмечает язык как "Ready to publish" → добавляется в `available_languages`
- Критерии готовности:
  - 100% checkpoint'ов имеют `title_i18n[lang]`
  - 100% checkpoint'ов имеют audio URL для языка
  - (опционально) 100% checkpoint'ов имеют `description_i18n[lang]`

**Связанные US**: US-039

---

### BR-017: Добавление языка не создает версию
**Правило**: Добавление нового языка в опубликованную версию НЕ создает новую версию маршрута.

**Детали**:
- Добавление языка = изменение метаданных (аналог BR-004)
- Язык добавляется "in-place" к существующей published версии
- Обновляется `route_version.available_languages` поле

**Связанные US**: US-039

---

### BR-018: Языки добавляются только в актуальную версию
**Правило**: Новые языки добавляются только в последнюю (актуальную) версию маршрута.

**Детали**:
- Старые (superseded) версии НЕ обновляются новыми языками
- У контент-менеджера "всегда временная копия" (draft версия)
- Если пользователь на старой версии - он не увидит новый язык

**Обоснование**: Упрощение управления контентом.

**Связанные US**: US-039

---

## 5. Checkpoint Management (Управление точками маршрута)

### BR-019: Переиспользование checkpoint ID между версиями
**Правило**: При создании новой версии checkpoint ID должны переиспользоваться (где точка не изменилась).

**Детали**:
- Если точка осталась в том же месте (location не изменился):
  - Новая версия ссылается на тот же `checkpoint_master.id`
  - Обновления audio/метаданных в checkpoint_master применяются ко всем версиям
- Если точка удалена:
  - Связь с checkpoint_master разрывается (только для новой версии)
- Если точка добавлена:
  - Создается новый checkpoint_master

**Техническое решение**: Использовать таблицу `checkpoint_master` (см. план).

**Связанные US**: US-043

---

### BR-020: Автоинкремент seq_no при добавлении точек
**Правило**: Автоинкремент `seq_no` и `display_number` при добавлении новых точек.

**Детали**:
- При добавлении новой точки редактор указывает "insert after checkpoint X"
- Backend пересчитывает `seq_no` для всех последующих точек
- `display_number` также пересчитывается для видимых точек

**Связанные US**: US-019, US-038

---

### BR-021: Стабильность checkpoint.id при пересчете
**Правило**: `display_number` и `seq_no` пересчитываются при изменении порядка, но `checkpoint.id` остается стабильным.

**Детали**:
- `seq_no` - внутренний порядок для GPS логики
- `display_number` - видимый номер для пользователя
- `checkpoint.id` - неизменяемый идентификатор для прогресса

**Связанные US**: US-036, US-043

---

### BR-022: Пересчет seq_no при удалении точки
**Правило**: При удалении точки из середины маршрута, `seq_no` пересчитывается для последующих точек.

**Пример**:
```
До удаления: [1, 2, 3, 4, 5]
Удалили точку seq_no=3
После: [1, 2, 4→3, 5→4]
```

**Связанные US**: US-038

---

### BR-023: Insert after для добавления точек
**Правило**: При добавлении точки редактор указывает "insert after checkpoint X".

**Детали**:
- В UI drag-and-drop интерфейс
- Backend получает `previous_checkpoint_id`
- Новая точка получает `seq_no = previous.seq_no + 1`
- Все последующие точки сдвигаются на +1

**Связанные US**: US-019

---

## 6. Progress Tracking (Отслеживание прогресса)

### BR-024: Прогресс считается на клиенте
**Правило**: Прогресс считается на клиенте (для offline режима).

**Детали**:
- Мобильное приложение вычисляет процент прохождения локально
- Формула: `completed_checkpoints / total_checkpoints * 100`
- Синхронизация с сервером при наличии сети

**Обоснование**: При работе маршрута в offline режиме невозможно связываться с базой.

**Связанные US**: US-012a, US-040

---

### BR-025: Идемпотентность отправки прогресса
**Правило**: Пользователь может отправить прогресс повторно (idempotent endpoint).

**Детали**:
- Endpoint `POST /api/v1/routes/checkpoints/{id}/visited` идемпотентен
- Если checkpoint уже отмечен как `visited=true, audio_status=completed`:
  - Повторный вызов не изменяет данные
  - Возвращается текущее состояние
- Правило "last write wins" по timestamp для конфликтов

**Связанные US**: US-040

---

### BR-026: Прогресс по checkpoints
**Правило**: Прогресс вычисляется на основе `visited_points` таблицы (GPS + audio_status).

**Детали**:
- Checkpoint считается "завершенным", если:
  - `visited = true` (был в GPS-зоне)
  - `audio_status = 'completed'` (прослушал аудио до конца)
- Checkpoint считается "в процессе", если:
  - `audio_status = 'started'` (начал слушать)
- Checkpoint считается "не пройден", если:
  - `visited = false AND audio_status = 'none'`

**Связанные US**: US-012c (цветовые статусы точек)

---

### BR-027: GPS без аудио записывается
**Правило**: Если пользователь попал в GPS-зону точки, но не запустил аудио - это записывается как `visited=true, audio_status=none`.

**Детали**:
- Frontend вызывает `POST /checkpoints/{id}/visited` при входе в GPS-зону
- Backend устанавливает `visited=true, visited_at=now()`
- `audio_status` остается `'none'` пока не начнется воспроизведение
- Цвет точки: серый (GPS visited, audio not started)

**Обоснование**: Пользователь мог проехать мимо точки без остановки.

**Связанные US**: US-011b, US-012c

---

## Приложение: Связь бизнес-правил с user stories

| Бизнес-правило | User Story |
|----------------|------------|
| BR-001, BR-002, BR-003 | US-021, US-038 |
| BR-004, BR-011, BR-013 | US-037 |
| BR-005, BR-012 | US-036, US-037 |
| BR-006 | US-019, US-020, US-037 |
| BR-007, BR-008 | US-021, US-036 |
| BR-009, BR-010 | US-036 |
| BR-014 | US-038 |
| BR-015, BR-016, BR-017, BR-018 | US-039 |
| BR-019, BR-020, BR-021, BR-022, BR-023 | US-019, US-038, US-043 |
| BR-024, BR-025, BR-026, BR-027 | US-011b, US-012a, US-012c, US-040 |

---

## История изменений

| Дата | Автор | Изменения |
|------|-------|-----------|
| 2025-12-30 | Claude Code | Первая версия, 27 бизнес-правил из обсуждения версионирования |
